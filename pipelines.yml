apiVersion: v1.1
resources:
  - name: gitJfrogPipelinesImage
    type: GitRepo
    configuration:
      gitProvider: githubAccountGeoffwilliams
      path: declarativesystems/jfrog-pipelines-image

pipelines:
  - name: jfrogPipelinesImage
    steps:
      - name: dockerBuild
        type: DockerBuild
        configuration:
          affinityGroup: jfrogPipelinesImage
          dockerFileLocation: .
          dockerFileName: Dockerfile
          dockerImageName: ${dockerImageName}
          dockerImageTag: ${dockerImageVersion}
          inputResources:
            - name: gitJfrogPipelinesImage
          integrations:
            - name: artifactory
        execution:
          onStart:
            - cd $res_gitJfrogPipelinesImage_resourcePath
            - add_pipeline_variables dockerImageVersion=$(make print_image_tag)
            - add_pipeline_variables dockerImageName=$(make print_image_name)
          onFailure:
            - tree -L 4
      - name: dockerPush
        type: DockerPush
        configuration:
          affinityGroup: jfrogPipelinesImage
          targetRepository: docker-local
          integrations:
            - name: artifactory
          inputSteps:
            - name: dockerBuild
